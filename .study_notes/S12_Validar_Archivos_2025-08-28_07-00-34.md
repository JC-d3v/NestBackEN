## Resumen de avance
Loaded cached credentials.
Claro, aquí tienes el apunte de estudio en formato Markdown basado en los cambios del commit.

# S12: Validación de Archivos en NestJS

En esta sección, implementamos una validación crucial para la subida de archivos, asegurando que el _backend_ solo acepte imágenes con formatos específicos (jpg, png, jpeg, gif). Esto se logra mediante un `fileFilter` personalizado, una característica del interceptor `FileInterceptor` de NestJS.

## Puntos Clave

1.  **Creación de un `fileFilter` Helper:** Se abstrae la lógica de validación a una función auxiliar para mantener el código limpio y reutilizable.
2.  **Integración con `FileInterceptor`:** Se configura el `FileInterceptor` en el controlador para que utilice nuestra función de filtro antes de procesar cualquier archivo subido.
3.  **Manejo de Archivos no Válidos:** Se lanza una excepción `BadRequestException` si el archivo no cumple con las validaciones, informando claramente al cliente del error.

---

### 1. Creación del `fileFilter.helper.ts`

Para no saturar el controlador, creamos un archivo auxiliar (`/helpers/fileFilter.helper.ts`) que contiene la lógica para validar el tipo de archivo. Esta función se adhiere a la firma esperada por `Multer` (la librería que NestJS usa internamente para manejar archivos).

> La función `fileFilter` recibe la petición (`req`), el archivo (`file`) y un `callback`. El `callback` es una función que le indica a Multer si debe aceptar (`callback(null, true)`) o rechazar (`callback(null, false)`) el archivo.

export const fileFilter = (req: Express.Request, file: Express.Multer.File, callback: Function) => {

	// Si no se proporciona un archivo, se retorna un error explícito.
	if (!file) return callback(new Error('File is Empty'), false);

	// Extraemos la extensión del archivo a partir de su mimetype (ej: 'image/jpeg' => 'jpeg')
	const fileExtension = file.mimetype.split('/')[1];
	const validExtensions = ['jpg', 'png', 'jpeg', 'gif'];

	// Si la extensión del archivo está en nuestra lista de extensiones válidas…
	if (validExtensions.includes(fileExtension)) {
		// …aceptamos el archivo.
		return callback(null, true);
	}

	// Si la extensión no es válida, rechazamos el archivo (sin lanzar un error).
	callback(null, false);

}

### 2. Integración en `FilesController`

Con el _helper_ ya creado, lo importamos y lo integramos en el `FilesController`. El `FileInterceptor` acepta un objeto de opciones como segundo argumento, donde podemos especificar nuestro `fileFilter`.

> Cuando nuestro `fileFilter` ejecuta `callback(null, false)`, el objeto `file` dentro del método del controlador será `undefined`. Esto nos permite controlar y responder adecuadamente.

import { Controller, Post, UploadedFile, UseInterceptors, BadRequestException } from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import { FilesService } from './files.service';
import { fileFilter } from './helpers/fileFilter.helper'; // 1. Importamos el helper

@Controller('files')
export class FilesController {
	constructor(private readonly filesService: FilesService) { }

	@Post('product')
	@UseInterceptors(FileInterceptor('file', {
		// 2. Aquí aplicamos el filtro personalizado
		fileFilter: fileFilter
	}))
	uploadProductImage(
		@UploadedFile()
		file: Express.Multer.File,
	) {

		// 3. Si el filtro rechaza el archivo, 'file' llegará como undefined.
		if (!file) {
			throw new BadRequestException('Asegúrese de que el archivo sea una imagen (jpg, png, jpeg, gif)...');
		}

		return {
			filename: file.originalname
		};
	}
}

### Importancia de la Validación de Archivos

*   **Seguridad:** Es una de las primeras líneas de defensa para prevenir la subida de archivos maliciosos o ejecutables que podrían comprometer el servidor.
*   **Consistencia de Datos:** Asegura que solo se almacenen los tipos de archivo que la aplicación espera y sabe cómo manejar, evitando errores en futuras operaciones.
*   **Experiencia de Usuario (UX):** Al lanzar una `BadRequestException`, se le informa claramente al cliente por qué su solicitud falló, permitiéndole corregir el error y volver a intentarlo.

---
*Este apunte fue generado automáticamente.*
