## Resumen de avance
Loaded cached credentials.
Claro, aquí tienes el apunte de estudio basado en los cambios del commit.

---

# S11: Transacciones con Query Runner en TypeORM

En el desarrollo de aplicaciones, especialmente en operaciones complejas que involucran múltiples pasos de escritura en la base de datos, es crucial garantizar la integridad de los datos. Una transacción es un mecanismo que agrupa una serie de operaciones y se asegura de que todas se ejecuten con éxito o, si una falla, ninguna de ellas se aplique. Esto se conoce como atomicidad.

El `diff` del commit nos muestra cómo implementar transacciones en NestJS usando el **Query Runner** de TypeORM.

### ¿Por Qué es Importante Este Cambio?

Antes del cambio, la actualización de un producto y sus imágenes se realizaba en pasos separados. Si la actualización del producto tenía éxito pero la manipulación de las imágenes fallaba, podíamos terminar con un estado de datos inconsistente.

La transacción resuelve esto: la actualización del producto y la gestión de sus imágenes ahora son una única operación atómica. O todo se completa correctamente, o todo se revierte al estado original.

### El Flujo de una Transacción con Query Runner

El código implementa un flujo de transacción manual, que nos da control total sobre el proceso.

1.  **Crear y Conectar el Query Runner**: Se obtiene una instancia del `QueryRunner` desde la fuente de datos (`dataSource`) y se establece una conexión a la base de datos.
2.  **Iniciar la Transacción**: Se marca el inicio del bloque de operaciones atómicas.
3.  **Ejecutar Operaciones**: Todas las operaciones de base de datos (eliminar, guardar, etc.) se ejecutan a través del `manager` del `queryRunner`. Esto es fundamental para que formen parte de la transacción.
4.  **Commit o Rollback**:
    *   Si todas las operaciones dentro del bloque `try` tienen éxito, se llama a `commitTransaction()` para aplicar los cambios de forma permanente.
    *   Si ocurre cualquier error, el bloque `catch` se activa y `rollbackTransaction()` revierte todos los cambios realizados durante la transacción.
5.  **Liberar el Query Runner**: Es **crucial** llamar a `release()` al final, tanto en el `try` como en el `catch`. Esto devuelve la conexión a la base de datos al pool de conexiones, evitando fugas que podrían agotar los recursos del servidor.

### Análisis del Código

Veamos cómo se aplican estos conceptos en el método `update`.

// 04-teslo-shop/src/products/products.service.ts

async update(id: string, updateProductDto: UpdateProductDto) {

    const { images, ...toUpdate } = updateProductDto;

    const product = await this.productRepository.preload({ id, ...toUpdate });

    if (!product) throw new NotFoundException(`Product with id: ${id} not found`);

    // 1. Crear y conectar el Query Runner
    const queryRunner = this.dataSource.createQueryRunner();
    await queryRunner.connect();
    // 2. Iniciar la transacción
    await queryRunner.startTransaction();

    try {
        // 3. Ejecutar operaciones con el manager del queryRunner
        if (images) {
            // Se eliminan las imágenes anteriores
            await queryRunner.manager.delete(ProductImage, { product: { id } });

            // Se crean las nuevas instancias de imágenes
            product.images = images.map(
                image => this.productImageRepository.create({ url: image })
            )
        }

        // Se guarda el producto con sus relaciones actualizadas
        await queryRunner.manager.save(product);

        // 4. Si todo va bien, se hace commit
        await queryRunner.commitTransaction();
        // 5. Se libera la conexión
        await queryRunner.release();

        return this.findOnePlain(id);

    } catch (error) {

        // 4. Si algo falla, se hace rollback
        await queryRunner.rollbackTransaction();
        // 5. Se libera la conexión
        await queryRunner.release();

        this.handleDBExceptions(error)
    }
}

### Puntos Clave a Recordar

*   **Atomicidad**: Las transacciones garantizan que las operaciones complejas sean "todo o nada".
*   **Query Runner**: Es la herramienta de TypeORM para gestionar transacciones manualmente.
*   **`queryRunner.manager`**: Usa siempre el `manager` del `queryRunner` para las operaciones que deben estar dentro de la transacción.
*   **`release()`**: Nunca olvides liberar el `queryRunner` para evitar fugas de conexión. Es tan importante como el `commit` o el `rollback`.

---
*Este apunte fue generado automáticamente.*
