## Resumen de avance
Claro, aquí tienes el apunte de estudio en formato Markdown basado en el commit proporcionado.

# S13: Verificación de Estado de Autenticación y Renovación de JWT

En esta sección, implementamos un endpoint crucial para mejorar la experiencia de usuario en aplicaciones autenticadas. El objetivo es permitir que el frontend verifique el estado de la autenticación del usuario y, al mismo tiempo, renueve su JSON Web Token (JWT), extendiendo la sesión sin necesidad de volver a iniciarla.

## 1. Creación del Endpoint en el Controlador

Se añade un nuevo método en `auth.controller.ts` para manejar esta lógica.

// 04-teslo-shop/src/auth/auth.controller.ts

// ...

  @Get('check-status')
  @Auth()
  checkAuthStatus(
    @GetUser() user: User
  ) {
    return this.authService.checkAuthStatus(user)
  }

// ...

### Puntos Clave del Controlador:

*   **`@Get('check-status')`**: Define una nueva ruta de tipo `GET` en `/auth/check-status`.
*   **`@Auth()`**: Este es nuestro decorador compuesto que protege la ruta. Asegura que solo los usuarios con un JWT válido puedan acceder a este endpoint.
*   **`@GetUser() user: User`**: Utilizamos nuestro decorador personalizado `@GetUser` para extraer de la `request` el objeto completo del usuario que fue validado por el `JwtStrategy`.

## 2. Implementación de la Lógica en el Servicio

El controlador delega la tarea al `auth.service.ts`, donde se añade el método `checkAuthStatus`.

// 04-teslo-shop/src/auth/auth.service.ts

// ...

  async checkAuthStatus(user: User) {

    return {
      ...user,
      token: this.getJwtToken({ id: user.id })
    };
  }

// ...

### Puntos Clave del Servicio:

*   El método recibe el objeto `user` que viene desde el controlador.
*   La función retorna un nuevo objeto que contiene:
    *   **`...user`**: Todas las propiedades del usuario actual (email, roles, nombre completo, etc.), esparcidas en el objeto de respuesta.
    *   **`token: this.getJwtToken({ id: user.id })`**: Lo más importante—se genera un **nuevo JWT**. Esto permite que el frontend reemplace el token que tiene, extendiendo la duración de la sesión del usuario.

## Importancia de esta Funcionalidad

Este endpoint es fundamental en el ciclo de vida de la autenticación de una Single-Page Application (SPA):

1.  **Verificación de Sesión**: Cuando un usuario recarga la aplicación o vuelve a ella, el frontend puede llamar a `/auth/check-status`.
2.  **Renovación de Token**: Si la llamada es exitosa, el frontend recibe los datos actualizados del usuario y un nuevo token, manteniendo la sesión activa.
3.  **Manejo de Sesión Expirada**: Si la llamada falla (porque el token original ya expiró), el `AuthGuard` devolverá un error `401 Unauthorized`. El frontend puede capturar este error para redirigir al usuario a la página de login.
